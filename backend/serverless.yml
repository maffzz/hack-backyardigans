org: maferlazon
service: alertautec-backend

provider:
  name: aws
  runtime: python3.13
  memorySize: 1024
  timeout: 30
  stage: dev
  region: us-east-1
  iam:
    role: arn:aws:iam::096410127560:role/LabRole
  environment:
    STAGE: ${self:provider.stage}
    SERVICE_NAME: ${self:service}
    AWS_REGION: ${self:provider.region}
    S3_BUCKET: ${self:service}-attachments-${self:provider.stage}
    REPORTS_BUCKET: ${self:service}-reportes-${self:provider.stage}
    SNS_TOPIC_ARN:
      Ref: IncidentNotificationsTopic

functions:

  # --- AUTHENTICATION SYSTEM ---

  RegisterUser:
    handler: auth/RegisterUser.lambda_handler
    events:
      - http:
          path: auth/register
          method: post
          cors: true
          integration: lambda

  GenerateToken:
    handler: auth/GenerateTokenAcceso.lambda_handler
    events:
      - http:
          path: auth/login
          method: post
          cors: true
          integration: lambda

  ValidarTokenAcceso:
    handler: auth/ValidarTokenAcceso.lambda_handler


  # --- STUDENT ---

  createIncident:
    handler: student/createIncident.handler
    events:
      - http:
          path: student/incidents
          method: post
          cors: true
          integration: lambda

  listIncidents:
    handler: student/listIncidents.handler
    events:
      - http:
          path: student/incidents
          method: get
          cors: true
          integration: lambda

  listMine:
    handler: student/listMine.handler
    events:
      - http:
          path: student/incidents/mine
          method: get
          cors: true
          integration: lambda

  getIncident:
    handler: student/getIncident.handler
    events:
      - http:
          path: student/incidents/{id}
          method: get
          cors: true
          integration: lambda-proxy

  uploadAttachment:
    handler: student/uploadAttachment.handler
    events:
      - http:
          path: student/incidents/{id}/attachments
          method: post
          cors: true
          integration: lambda-proxy

  validateLocation:
    handler: student/validateLocation.handler
    events:
      - http:
          path: student/incidents/validate-location
          method: post
          cors: true
          integration: lambda

  previewIncident:
    handler: student/previewIncident.handler
    events:
      - http:
          path: student/incidents/preview
          method: post
          cors: true
          integration: lambda

  statsBasic:
    handler: student/statsBasic.handler
    events:
      - http:
          path: student/incidents/stats/basic
          method: get
          cors: true
          integration: lambda


  # --- STAFF / ADMIN ---

  updateStatus:
    handler: staff/updateStatus.handler
    events:
      - http:
          path: staff/incidents/{id}/status
          method: put
          cors: true
          integration: lambda-proxy

  addComment:
    handler: staff/addComment.handler
    events:
      - http:
          path: staff/incidents/{id}/comment
          method: post
          cors: true
          integration: lambda-proxy

  assignDepartment:
    handler: staff/assignDepartment.handler
    events:
      - http:
          path: staff/incidents/{id}/assign
          method: post
          cors: true
          integration: lambda-proxy

  listForDepartment:
    handler: staff/listForDepartment.handler
    events:
      - http:
          path: staff/incidents/by-department
          method: get
          cors: true
          integration: lambda

  getIncidentEvents:
    handler: staff/getIncidentEvents.handler
    events:
      - http:
          path: staff/incidents/{id}/events
          method: get
          cors: true
          integration: lambda-proxy

  staffStats:
    handler: staff/staffStats.handler
    events:
      - http:
          path: staff/incidents/stats
          method: get
          cors: true
          integration: lambda

  notifyDepartmentIncident:
    handler: staff/notifyDepartmentIncident.handler


  sendEmailNotification:
    handler: notifications/sendEmailNotification.handler


resources:
  Resources:

    # --- AUTH TABLES ---

    Users:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Users
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    Tokens:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Tokens
        AttributeDefinitions:
          - AttributeName: token
            AttributeType: S
        KeySchema:
          - AttributeName: token
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST


    # --- INCIDENTES ---

    Incidentes:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Incidentes
        AttributeDefinitions:
          - AttributeName: incident_id
            AttributeType: S
        KeySchema:
          - AttributeName: incident_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    IncidenteEventos:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: IncidenteEventos
        AttributeDefinitions:
          - AttributeName: incident_id
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: incident_id
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    Departamentos:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Departamentos
        AttributeDefinitions:
          - AttributeName: departamento_id
            AttributeType: S
        KeySchema:
          - AttributeName: departamento_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    WebSocketConnections:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: websocket-backend-${self:provider.stage}-connections
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    AttachmentsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-attachments-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false

    AttachmentsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref AttachmentsBucket
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: PublicReadForObjects
              Effect: Allow
              Principal: "*"
              Action:
                - s3:GetObject
              Resource: !Sub "${AttachmentsBucket.Arn}/*"

    ReportsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-reportes-${self:provider.stage}

    IncidentNotificationsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-incident-notifications-${self:provider.stage}
        DisplayName: Incident Notifications
        Subscription:
          - Protocol: email
            Endpoint: martin.bonilla@utec.edu.pe